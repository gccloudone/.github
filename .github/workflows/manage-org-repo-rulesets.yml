name: Branch Protection Rulesets

on:
  push:
    branches:
      - main
    paths:
      - "repo-branch-rulesets/**/*.json"
  schedule:
    - cron: "0 6 * * *" # Run daily at 6 AM
  workflow_dispatch:

permissions: read-all

jobs:
  configure_rulesets_across_repos:
    runs-on: ubuntu-latest

    steps:
      - name: Create App token
        id: create_token
        uses: gccloudone/.github/.github/actions/create-app-token@main
        with:
          app-id: ${{ vars.GCCO_ADMIN_APP_ID }}
          private-key: ${{ secrets.GCCO_ADMIN_APP_KEY }}

      - name: Checkout repo
        uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2

      - name: Set up GitHub CLI
        run: |
          gh auth login --with-token <<< "${{ steps.create_token.outputs.token }}"

      - name: Configure rulesets in target repos
        env:
          GH_TOKEN: ${{ steps.create_token.outputs.token }}
        run: |
          set -e
          # List all repositories in the organization
          repos=$(gh api orgs/"${{ github.repository_owner }}"/repos --jq '.[].name')
          mapfile -t repos_array <<< "$repos"
          echo "Found repositories: ${repos_array[*]}"

          for repo in "${repos_array[@]}"; do
            echo "Processing repository: $repo"

            repo_ruleset_folder="repo-branch-rulesets/$repo"
            default_ruleset_file="repo-branch-rulesets/default-branch.json"

            # Determine which JSON files to use
            if [ -d "$repo_ruleset_folder" ]; then
              # Gather JSON files for this repo into an array
              mapfile -t repo_json_files < <(find "$repo_ruleset_folder" -type f -name '*.json')
            else
              repo_json_files=()
            fi

            # If no folder OR folder empty, use the default ruleset
            if [ "${#repo_json_files[@]}" -eq 0 ]; then
              echo "No repo-specific rulesets found for $repo. Using default ruleset."
              repo_json_files=("$default_ruleset_file")
            else
              echo "Using repo-specific rulesets for $repo."
            fi

            # Retrieve existing rulesets
            echo "Retrieving existing rulesets for $repo..."
            existing_rulesets_json=$(gh api "repos/${{ github.repository_owner }}/$repo/rulesets")

            # Use jq to build an associative array of name->id
            declare -A ruleset_map=()
            while IFS=',' read -r r_name r_id; do
              r_name="${r_name//\"/}"
              r_id="${r_id//\"/}"
              ruleset_map["$r_name"]="$r_id"
            done < <(echo "$existing_rulesets_json" | jq -r '.[] | [ .name, .id ] | @csv')

            echo "Existing rulesets for $repo:"
            for n in "${!ruleset_map[@]}"; do
              echo "  -> '$n' (ID: ${ruleset_map[$n]})"
            done

            # DELETE OBSOLETE RULESETS
            for n in "${!ruleset_map[@]}"; do
              id_to_delete="${ruleset_map[$n]}"
              found_file=false
              for json_file in "${repo_json_files[@]}"; do
                bn="$(basename "$json_file" .json)"
                if [ "$bn" = "$n" ]; then
                  found_file=true
                  break
                fi
              done
              if [ "$found_file" = false ]; then
                echo "Deleting obsolete ruleset '$n' (ID: $id_to_delete) in $repo"
                gh api "repos/${{ github.repository_owner }}/$repo/rulesets/$id_to_delete" \
                  --method DELETE
              fi
            done

            # CREATE OR UPDATE RULESETS
            for json_file in "${repo_json_files[@]}"; do
              template_name=$(basename "$json_file" .json)
              if [[ -n "${ruleset_map[$template_name]}" ]]; then
                ruleset_id="${ruleset_map[$template_name]}"
                echo "Updating ruleset '$template_name' (ID: $ruleset_id) in $repo"
                gh api "repos/${{ github.repository_owner }}/$repo/rulesets/$ruleset_id" \
                  --method PUT \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  --input "$json_file"
              else
                echo "Creating new ruleset '$template_name' in $repo"
                gh api "repos/${{ github.repository_owner }}/$repo/rulesets" \
                  --method POST \
                  -H "Accept: application/vnd.github+json" \
                  -H "X-GitHub-Api-Version: 2022-11-28" \
                  --input "$json_file"
              fi
            done

            unset ruleset_map
          done

